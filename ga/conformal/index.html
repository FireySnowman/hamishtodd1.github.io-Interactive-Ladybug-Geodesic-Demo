<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Conformal</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <!-- <input type="text" id="textbox"><br><br> -->
    <!-- beziers dude! Can CGA make nice beziers? -->

    <script>
        function sq(a) {
            return a * a
        }
        const TAU = Math.PI * 2.
        const HS3 = Math.sqrt(3.) / 2.
        const PHI = (1. + Math.sqrt(5.)) / 2.
        const smallerInLarger = {}

        var frameDelta = 0.
        var frameCount = 0
        const log = console.log
    </script>

    <script src="Multivector.js"></script>
    <script src="gaMeta.js"></script>
    <script src="cga.js"></script>
    <script src="cga.glsl"></script>
    <script>
        initCga()
    </script>
    <script src="ega.js"></script>
    <script src="ega.glsl"></script>
    <script src="cgaVizes.js"></script>

    <script src="three.js"></script>
    <script src="variables.js"></script>
    <script src="OrbitControls.js"></script>
    <script src="VRButton.js"></script>
    <script src="mouse.js"></script>
    <script src="skinning.js"></script>

    <script src="programming.js"></script>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    
    <script>
        let container = document.createElement('div')
        document.body.appendChild(container)
        
        initEga()
        initCgaVizes()

        initProgramming()

        initMouse()

        // initSkinning()

        scene.background = new THREE.Color(0x8F8F8F)

        camera.position.set(0, 1.6, 3.5)
        // camera.position.z += 10.

        let orbitControls = new OrbitControls(camera, container)
        orbitControls.target.set(0, 1.6, 0)
        orbitControls.update()

        const floorGeometry = new THREE.PlaneGeometry(4, 4)
        const floorMaterial = new THREE.MeshStandardMaterial({
            color: 0xeeeeee,
            roughness: 1.0,
            metalness: 0.0
        })
        const floor = new THREE.Mesh(floorGeometry, floorMaterial)
        floor.rotation.x = - Math.PI / 2
        floor.receiveShadow = true
        scene.add(floor)

        scene.add(new THREE.HemisphereLight(0x808080, 0x606060))

        const light = new THREE.DirectionalLight(0xffffff)
        light.position.set(0, 6, 0)
        light.castShadow = true
        light.shadow.camera.top = 2
        light.shadow.camera.bottom = - 2
        light.shadow.camera.right = 2
        light.shadow.camera.left = - 2
        light.shadow.mapSize.set(4096, 4096)
        scene.add(light)

        //

        renderer.setPixelRatio(window.devicePixelRatio)
        renderer.setSize(window.innerWidth, window.innerHeight)
        renderer.outputEncoding = THREE.sRGBEncoding
        renderer.shadowMap.enabled = true
        renderer.xr.enabled = true
        container.appendChild(renderer.domElement)

        document.body.appendChild(VRButton.createButton(renderer))

        // controllers

        let controller1 = renderer.xr.getController(0)
        // controller1.addEventListener('selectstart', onSelectStart)
        // controller1.addEventListener('selectend', onSelectEnd)
        scene.add(controller1)

        let controller2 = renderer.xr.getController(1)
        // controller2.addEventListener('selectstart', onSelectStart)
        // controller2.addEventListener('selectend', onSelectEnd)
        scene.add(controller2)

        const laserGeo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, -5)])
        const laser = new THREE.Line(laserGeo)
        controller1.add(laser.clone())
        controller2.add(laser.clone())

        window.addEventListener('resize', () => {

            camera.aspect = window.innerWidth / window.innerHeight
            camera.updateProjectionMatrix()

            renderer.setSize(window.innerWidth, window.innerHeight)
        })

        function render() {
            let clockDelta = clock.getDelta()
            frameDelta = clockDelta < .1 ? clockDelta : .1 //clamped because debugger pauses create weirdness
            ++frameCount
            
            // updateDqMeshes()
            // disorderedUpdate
            updatePanel()

            renderer.render(scene, camera)
        }
        renderer.setAnimationLoop(render)
    </script>

    <!-- <script type="importmap">
        {
            "imports": {
            "three": "https://unpkg.com/three@v0.151.3/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@v0.151.3/examples/jsm/"
            }
        }
        </script>
    <script type="module">
        import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';
        {
            const controllerModelFactory = new XRControllerModelFactory()

            let controllerGrip1 = renderer.xr.getControllerGrip(0)
            controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1))
            scene.add(controllerGrip1)

            let controllerGrip2 = renderer.xr.getControllerGrip(1)
            controllerGrip2.add(controllerModelFactory.createControllerModel(controllerGrip2))
            scene.add(controllerGrip2)
        }
    </script> -->
</body>

</html>