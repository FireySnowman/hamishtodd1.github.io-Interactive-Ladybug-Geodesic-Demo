<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>My first three.js app</title>
    <style>
        body {
            margin: 0;
        }
    </style>
</head>

<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

<!-- This is here purely for the benefit of -->
<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@v0.151.3/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@v0.151.3/examples/jsm/"
    }
  }
</script>

<script>
var scene
var camera
</script>

<script src="three.js"></script>
<script src="OrbitControls.js"></script>
<script src="VRButton.js"></script>
<script src="init.js"></script>

<body>
    
    <script type="module">
        
        let controller1, controller2

        let container = document.createElement('div')
        document.body.appendChild(container)

        scene = new THREE.Scene()
        scene.background = new THREE.Color(0x808080)

        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 10)
        camera.position.set(0, 1.6, 3.5)

        let orbitControls = new OrbitControls(camera, container)
        orbitControls.target.set(0, 1.6, 0)
        orbitControls.update()

        const floorGeometry = new THREE.PlaneGeometry(4, 4)
        const floorMaterial = new THREE.MeshStandardMaterial({
            color: 0xeeeeee,
            roughness: 1.0,
            metalness: 0.0
        })
        const floor = new THREE.Mesh(floorGeometry, floorMaterial)
        floor.rotation.x = - Math.PI / 2
        floor.receiveShadow = true
        scene.add(floor)

        scene.add(new THREE.HemisphereLight(0x808080, 0x606060))

        const light = new THREE.DirectionalLight(0xffffff)
        light.position.set(0, 6, 0)
        light.castShadow = true
        light.shadow.camera.top = 2
        light.shadow.camera.bottom = - 2
        light.shadow.camera.right = 2
        light.shadow.camera.left = - 2
        light.shadow.mapSize.set(4096, 4096)
        scene.add(light)

        //

        let renderer = new THREE.WebGLRenderer({ antialias: true })
        renderer.setPixelRatio(window.devicePixelRatio)
        renderer.setSize(window.innerWidth, window.innerHeight)
        renderer.outputEncoding = THREE.sRGBEncoding
        renderer.shadowMap.enabled = true
        renderer.xr.enabled = true
        container.appendChild(renderer.domElement)

        document.body.appendChild(VRButton.createButton(renderer))

        // controllers

        controller1 = renderer.xr.getController(0)
        // controller1.addEventListener('selectstart', onSelectStart)
        // controller1.addEventListener('selectend', onSelectEnd)
        scene.add(controller1)

        controller2 = renderer.xr.getController(1)
        // controller2.addEventListener('selectstart', onSelectStart)
        // controller2.addEventListener('selectend', onSelectEnd)
        scene.add(controller2)

        //Comment out when not connected to the internet!
        import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';
        {
            const controllerModelFactory = new XRControllerModelFactory()

            let controllerGrip1 = renderer.xr.getControllerGrip(0)
            controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1))
            scene.add(controllerGrip1)

            let controllerGrip2 = renderer.xr.getControllerGrip(1)
            controllerGrip2.add(controllerModelFactory.createControllerModel(controllerGrip2))
            scene.add(controllerGrip2)
        }

        const laserGeo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, -5)])
        const laser = new THREE.Line(laserGeo)
        controller1.add(laser.clone())
        controller2.add(laser.clone())

        window.addEventListener('resize', () => {

            camera.aspect = window.innerWidth / window.innerHeight
            camera.updateProjectionMatrix()

            renderer.setSize(window.innerWidth, window.innerHeight)
        })

        init()

        function render() {
            renderer.render(scene, camera)
        }
        renderer.setAnimationLoop(render)
    </script>
</body>

</html>